const fetch=require("node-fetch");const fs=require("fs");const express=require("express");var date=new Date;require("dotenv").config({});function sendAlertToTelegramRoom(message){var telegramUrl="https://api.telegram.org/bot6164025343:AAG0SjQeYboUHXEl_4P9gwPQ04j7L0YSxv0/sendMessage?chat_id=-960467766&text="+message;fetch(telegramUrl).then(response=>response.json()).then(data=>console.log(data)).catch(error=>console.error(error))}var scheduleRawData=fs.readFileSync("data/schedule.json","utf8");var scheduleData=JSON.parse(scheduleRawData);var todoRawData=fs.readFileSync("data/todo.json","utf8");var todoData=JSON.parse(todoRawData);var classTimeTable={"0교시":[700,750],"1교시":[800,840],"2교시":[850,1010],"3교시":[1030,1210],"점심시간":[1210,1310],"4교시":[1310,1420],"5교시":[1440,1600],"6교시":[1620,1730],"저녁시간":[1730,1830],"7교시":[1830,2e3],"8교시":[2020,2150]};async function save(){fs.writeFileSync("data/schedule.json",JSON.stringify(scheduleData));fs.writeFileSync("data/todo.json",JSON.stringify(todoData))}async function addZero(i){if(i<10){i="0"+i}return i}function scheduleCodeToTime(code){if(scheduleData["scheduleInfo"][code]==undefined){return"존재하지 않는 스케쥴"}else{if(scheduleData["scheduleInfo"][code]["time"]==3.5){return"3.5시간 스케쥴"}if(scheduleData["scheduleInfo"][code]["time"]==7){return"7시간 스케쥴"}}}async function checkSchedule(day){for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==day){return true}}}return false}async function nowTimeToClassTime(){var date=new Date;var nowTime=date.getHours();var nowMinute=date.getMinutes();var nowTimeCode=1050;console.log(nowTimeCode);for(var i=0;i<Object.keys(classTimeTable).length;i++){if(nowTimeCode>=classTimeTable[Object.keys(classTimeTable)[i]][0]&&nowTimeCode<=classTimeTable[Object.keys(classTimeTable)[i]][1]){return Object.keys(classTimeTable)[i]}if(i==Object.keys(classTimeTable).length-1){if(nowTimeCode>=classTimeTable[Object.keys(classTimeTable)[i]][1]){return"하원 후"}if(nowTimeCode<=classTimeTable[Object.keys(classTimeTable)[0]][0]){return"등원 전"}}if(nowTimeCode>=classTimeTable[Object.keys(classTimeTable)[i]][1]&&nowTimeCode<=classTimeTable[Object.keys(classTimeTable)[i+1]][0]){return Object.keys(classTimeTable)[i]+" 쉬는시간"}}}var checkScheduleRemainTimeVar="";async function checkScheduleRemainTimeGet(day){var todaySchedule=[];if(await checkSchedule(day)){checkScheduleRemainTimeVar="";for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==day){todaySchedule.push(Number(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[1]))}}}checkScheduleRemainTimeVar="단과수업: "+todaySchedule.length+"개"+"\n\n";await nowTimeToClassTime().then(nowTimeToClassTime=>{console.log("현재교시: "+nowTimeToClassTime);if(nowTimeToClassTime.includes("교시")){var nowClassTimeNumber=nowTimeToClassTime.split("교시")[0];for(var i=0;i<todaySchedule.length;i++){if(todaySchedule[i]>nowClassTimeNumber){checkScheduleRemainTimeVar+="다음 수업🏫: "+todaySchedule[i]+"교시";break}if(i==todaySchedule.length-1){checkScheduleRemainTimeVar+="다음 수업🏫: 없음";break}}}return checkScheduleRemainTimeVar})}else{checkScheduleRemainTimeVar="단과수업: 없음";return"단과수업: 없음"}}async function checkScheduleRemainTime(day){await checkScheduleRemainTimeGet(day);return checkScheduleRemainTimeVar}async function nowUserStatus(){var userStatusText="";await nowTimeToClassTime().then(nowTimeToClassTime=>{var date=new Date;var nowTime=date.getHours();var nowMinute=date.getMinutes();var dayOfWeek=date.getDay();var nowTimeCode=Number(String(nowTime)+String(nowMinute));if(nowTimeToClassTime.includes("교시")){var isBreakTime=nowTimeToClassTime.split("교시")[1]==" 쉬는시간";if(isBreakTime){userStatusText="쉬는중😴"}if(!isBreakTime){userStatusText="자습중🖊️"}var nowClassTimeNumber=nowTimeToClassTime.split("교시")[0];for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==dayOfWeek){for(var k=0;k<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j]).length;k++){if(Number(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][k].split("-")[1])==nowClassTimeNumber){userStatusText="수업중🔥";console.log("수업중🔥")}}}}}}});return userStatusText}var nowClassInfoText="";async function nowClassInfoGet(){var userStatusData=await nowUserStatus();await nowTimeToClassTime().then(nowTimeToClassTime=>{var date=new Date;var dayOfWeek=date.getDay();if(userStatusData=="수업중🔥"){var nowClassTimeNumber=nowTimeToClassTime.split("교시")[0];for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==dayOfWeek){for(var k=0;k<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j]).length;k++){if(Number(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][k].split("-")[1])==nowClassTimeNumber){nowClassInfoText=scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["teacher"]+" - "+scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["subject"]}}}}}}else{nowClassInfoText="수업중이 아닙니다."}})}async function nowClassInfo(){await nowClassInfoGet();return nowClassInfoText}async function registerSchedule(code,time,teacher,subject,room,timeData){try{if(scheduleData["scheduleInfo"][code]!=undefined){return"이미 존재하는 스케쥴"}else{var timeData0;if(timeData.includes("/")){var timeData1=timeData.split("/")[0];var timeData2=timeData.split("/")[1];timeData0={0:timeData1,1:timeData2}}else{timeData0={0:timeData}}scheduleData["scheduleInfo"][code]={time:String(time),teacher:teacher,subject:subject,room:room,timeData:timeData0};console.log(scheduleData);await save()}}catch(err){scheduleData["scheduleInfo"][code]={};registerSchedule(code,time,teacher,subject,room,timeData)}}const TelegramBot=require("node-telegram-bot-api");const token="6164025343:AAG0SjQeYboUHXEl_4P9gwPQ04j7L0YSxv0";const bot=new TelegramBot(token,{polling:true});var userSetting={};bot.onText(/\/dev/,async msg=>{const chatId=msg.chat.id;bot.sendMessage(chatId,await nowClassInfo())});bot.onText(/\/menu/,msg=>{const chatId=msg.chat.id;const userId=msg.from.id;if(userSetting[userId]==undefined){userSetting[userId]={}}const options={reply_markup:{inline_keyboard:[[{text:"메인 메뉴",callback_data:"main_menu"}],[{text:"설정",callback_data:"settings"}]]}};bot.sendMessage(chatId,"메뉴를 선택해주세요.",options)});bot.onText(/\/settings/,msg=>{const chatId=msg.chat.id;const userId=msg.from.id;if(userSetting[userId]==undefined){userSetting[userId]={}}const options={reply_markup:{inline_keyboard:[[{text:"수업 관리",callback_data:"manage_class"}]]}};bot.sendMessage(chatId,"메뉴를 선택해주세요.",options)});bot.on("callback_query",async query=>{try{console.log(query);const chatId=query.message.chat.id;const messageId=query.message.message_id;const data=query.data;const userId=query.from.id;var year=date.getFullYear();var month=date.getMonth()+1;var day=date.getDate();var dayOfWeek=date.getDay();var dayOfWeekKorean=["일","월","화","수","목","금","토"][dayOfWeek];if(data=="main_menu"){const options={reply_markup:{inline_keyboard:[[{text:"내 학습정보 확인",callback_data:"my_study_info"}],[{text:"설정",callback_data:"settings"}]]}};bot.editMessageText("메뉴를 선택해주세요.",{chat_id:chatId,message_id:messageId,reply_markup:options.reply_markup})}if(data=="settings"){if(userSetting[userId]==undefined){userSetting[userId]={}}const options={reply_markup:{inline_keyboard:[[{text:"수업 관리",callback_data:"manage_class"}]]}};bot.sendMessage(chatId,"설정입니다.",options)}if(data=="my_study_info"){var myStudyInfoText=`[${year}년 ${month}월 ${day}일 ${dayOfWeekKorean}요일] 내 학습정보\n\n`;if(await nowClassInfo()=="수업중이 아닙니다."){myStudyInfoText+="내 상태: "+await nowUserStatus()}else{myStudyInfoText+="내 상태: "+await nowUserStatus()+"("+await nowClassInfo()+")"}myStudyInfoText+="\n"+await checkScheduleRemainTime(dayOfWeek);bot.editMessageText(myStudyInfoText,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"메인 메뉴",callback_data:"main_menu"}]]}})}if(data=="manage_class"){var message="수업 관리 메뉴입니다.";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"수업 추가",callback_data:"add_class"}],[{text:"수업 수정",callback_data:"edit_class"}]]}})}if(data=="add_class"){const namePrompt1=await bot.sendMessage(query.message.chat.id,"수업 추가 메뉴입니다.\n\n수업코드를 보내주세요.\n(1/6)",{reply_markup:{force_reply:true}});bot.onReplyToMessage(query.message.chat.id,namePrompt1.message_id,async classData1=>{userSetting[userId]["code"]=classData1.text;await bot.deleteMessage(query.message.chat.id,classData1.message_id);await bot.deleteMessage(query.message.chat.id,namePrompt1.message_id);const namePrompt2=await bot.sendMessage(query.message.chat.id,"수업 추가 메뉴입니다.\n\n강사명을 보내주세요.\n(2/6)",{reply_markup:{force_reply:true}});bot.onReplyToMessage(query.message.chat.id,namePrompt2.message_id,async classData2=>{userSetting[userId]["teacher"]=classData2.text;var message="수업 추가 메뉴입니다.\n\n수업시수를 선택해주세요.\n(3/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"3.5",callback_data:"add_class_time_3.5"}],[{text:"7",callback_data:"add_class_time_7"}]]}});bot.deleteMessage(query.message.chat.id,classData2.message_id);bot.deleteMessage(query.message.chat.id,namePrompt2.message_id)})})}if(data.includes("add_class_time_")){userSetting[userId]["time"]=data.split("_")[3];userSetting[userId]["time"]=3.5;var message="수업 추가 메뉴입니다.\n\n과목명을 선택해주세요.\n(4/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"국어",callback_data:"add_class_subject_국어"}],[{text:"영어",callback_data:"add_class_subject_영어"}],[{text:"수학",callback_data:"add_class_subject_수학"}]]}})}if(data.includes("add_class_subject_")){userSetting[userId]["subject"]=data.split("_")[3];var message="수업 추가 메뉴입니다.\n\n강의실을 선택해주세요.\n(5/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"201호",callback_data:"add_class_room_201"}],[{text:"202호",callback_data:"add_class_room_202"}],[{text:"203호",callback_data:"add_class_room_203"}],[{text:"204호",callback_data:"add_class_room_204"}],[{text:"205호",callback_data:"add_class_room_205"}],[{text:"206호",callback_data:"add_class_room_206"}],[{text:"207호",callback_data:"add_class_room_207"}],[{text:"208호",callback_data:"add_class_room_208"}],[{text:"VIP실",callback_data:"add_class_room_VIP"}]]}})}if(data.includes("add_class_room_")){userSetting[userId]["room"]=data.split("_")[3];var message="수업 추가 메뉴입니다.\n\n강의 요일을 선택해주세요.\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"일요일",callback_data:"add_class_day_0"}],[{text:"월요일",callback_data:"add_class_day_1"}],[{text:"화요일",callback_data:"add_class_day_2"}],[{text:"수요일",callback_data:"add_class_day_3"}],[{text:"목요일",callback_data:"add_class_day_4"}],[{text:"금요일",callback_data:"add_class_day_5"}],[{text:"토요일",callback_data:"add_class_day_6"}]]}})}if(data.includes("add_class_day_")){userSetting[userId]["day1"]=data.split("_")[3];var message="수업 추가 메뉴입니다.\n\n수업 시간을 선택해주세요\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"오전",callback_data:"add_class_partTime_1"}],[{text:"점심",callback_data:"add_class_partTime_2"}],[{text:"저녁",callback_data:"add_class_partTime_3"}]]}})}if(data.includes("add_class_partTime_")){userSetting[userId]["partTime"]=data.split("_")[3];if(userSetting[userId]["time"]==3.5){var message="수업 추가 메뉴입니다.\n\n수업을 추가하시겠습니까?\n\n강의 코드: "+userSetting[userId]["code"]+"\n과목: "+userSetting[userId]["subject"]+"\n강의실: "+userSetting[userId]["room"]+"\n강의 요일: "+userSetting[userId]["day1"]+"\n강의 시간대: "+userSetting[userId]["partTime"]+"\n\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"등록",callback_data:"add_class_final_okay"}],[{text:"취소",callback_data:"add_class_final_cancel"}]]}})}else if(userSetting[userId]["time"]==7){var message="수업 추가 메뉴입니다.\n\n7T 단과는 지원하지 않고 있으니, 수동으로 추가하세요.\n\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"메인 메뉴로 돌아가기",callback_data:"main_menu"}]]}})}}if(data.includes("add_class_final_")){console.log("!!!!!!!!");if(data.split("_")[3]=="okay"){var classDateInfo=[];if(userSetting[userId]["time"]==3.5){if(userSetting[userId]["partTime"]==1){classDateInfo.push(`${userSetting[userId]["day1"]}-2`);classDateInfo.push(`${userSetting[userId]["day1"]}-3`)}else if(userSetting[userId]["partTime"]==2){classDateInfo.push(`${userSetting[userId]["day1"]}-4`);classDateInfo.push(`${userSetting[userId]["day1"]}-5`);classDateInfo.push(`${userSetting[userId]["day1"]}-6`)}else if(userSetting[userId]["partTime"]==3){classDateInfo.push(`${userSetting[userId]["day1"]}-7`);classDateInfo.push(`${userSetting[userId]["day1"]}-8`)}registerSchedule(userSetting[userId]["code"],userSetting[userId]["time"],userSetting[userId]["teacher"],userSetting[userId]["subject"],userSetting[userId]["room"],classDateInfo);var message="수업 추가 메뉴입니다.\n\n등록이 완료되었습니다. ✅";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"메인 메뉴로 돌아가기",callback_data:"main_menu"}]]}})}}if(data.split("_")[3]=="cancel"){var message="수업 추가 메뉴입니다.\n\n취소되었습니다.";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"다시 등록하기",callback_data:"add_class"}],[{text:"나가기",callback_data:"add_class_delete"}]]}})}}if(data.includes("add_class_delete")){await bot.deleteMessage(chatId,messageId)}}catch(err){console.log(err)}});