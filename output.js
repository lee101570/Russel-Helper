const fetch=require("node-fetch");const fs=require("fs");const express=require("express");var date=new Date;require("dotenv").config({});function sendAlertToTelegramRoom(message){var telegramUrl="https://api.telegram.org/bot6164025343:AAG0SjQeYboUHXEl_4P9gwPQ04j7L0YSxv0/sendMessage?chat_id=-960467766&text="+message;fetch(telegramUrl).then(response=>response.json()).then(data=>console.log(data)).catch(error=>console.error(error))}var scheduleRawData=fs.readFileSync("data/schedule.json","utf8");var scheduleData=JSON.parse(scheduleRawData);var todoRawData=fs.readFileSync("data/todo.json","utf8");var todoData=JSON.parse(todoRawData);var classTimeTable={"0êµì‹œ":[700,750],"1êµì‹œ":[800,840],"2êµì‹œ":[850,1010],"3êµì‹œ":[1030,1210],"ì ì‹¬ì‹œê°„":[1210,1310],"4êµì‹œ":[1310,1420],"5êµì‹œ":[1440,1600],"6êµì‹œ":[1620,1730],"ì €ë…ì‹œê°„":[1730,1830],"7êµì‹œ":[1830,2e3],"8êµì‹œ":[2020,2150]};async function save(){fs.writeFileSync("data/schedule.json",JSON.stringify(scheduleData));fs.writeFileSync("data/todo.json",JSON.stringify(todoData))}async function addZero(i){if(i<10){i="0"+i}return i}function scheduleCodeToTime(code){if(scheduleData["scheduleInfo"][code]==undefined){return"ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìŠ¤ì¼€ì¥´"}else{if(scheduleData["scheduleInfo"][code]["time"]==3.5){return"3.5ì‹œê°„ ìŠ¤ì¼€ì¥´"}if(scheduleData["scheduleInfo"][code]["time"]==7){return"7ì‹œê°„ ìŠ¤ì¼€ì¥´"}}}async function checkSchedule(day){for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==day){return true}}}return false}async function nowTimeToClassTime(){var date=new Date;var nowTime=date.getHours();var nowMinute=date.getMinutes();var nowTimeCode=1050;console.log(nowTimeCode);for(var i=0;i<Object.keys(classTimeTable).length;i++){if(nowTimeCode>=classTimeTable[Object.keys(classTimeTable)[i]][0]&&nowTimeCode<=classTimeTable[Object.keys(classTimeTable)[i]][1]){return Object.keys(classTimeTable)[i]}if(i==Object.keys(classTimeTable).length-1){if(nowTimeCode>=classTimeTable[Object.keys(classTimeTable)[i]][1]){return"í•˜ì› í›„"}if(nowTimeCode<=classTimeTable[Object.keys(classTimeTable)[0]][0]){return"ë“±ì› ì „"}}if(nowTimeCode>=classTimeTable[Object.keys(classTimeTable)[i]][1]&&nowTimeCode<=classTimeTable[Object.keys(classTimeTable)[i+1]][0]){return Object.keys(classTimeTable)[i]+" ì‰¬ëŠ”ì‹œê°„"}}}var checkScheduleRemainTimeVar="";async function checkScheduleRemainTimeGet(day){var todaySchedule=[];if(await checkSchedule(day)){checkScheduleRemainTimeVar="";for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==day){todaySchedule.push(Number(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[1]))}}}checkScheduleRemainTimeVar="ë‹¨ê³¼ìˆ˜ì—…: "+todaySchedule.length+"ê°œ"+"\n\n";await nowTimeToClassTime().then(nowTimeToClassTime=>{console.log("í˜„ì¬êµì‹œ: "+nowTimeToClassTime);if(nowTimeToClassTime.includes("êµì‹œ")){var nowClassTimeNumber=nowTimeToClassTime.split("êµì‹œ")[0];for(var i=0;i<todaySchedule.length;i++){if(todaySchedule[i]>nowClassTimeNumber){checkScheduleRemainTimeVar+="ë‹¤ìŒ ìˆ˜ì—…ğŸ«: "+todaySchedule[i]+"êµì‹œ";break}if(i==todaySchedule.length-1){checkScheduleRemainTimeVar+="ë‹¤ìŒ ìˆ˜ì—…ğŸ«: ì—†ìŒ";break}}}return checkScheduleRemainTimeVar})}else{checkScheduleRemainTimeVar="ë‹¨ê³¼ìˆ˜ì—…: ì—†ìŒ";return"ë‹¨ê³¼ìˆ˜ì—…: ì—†ìŒ"}}async function checkScheduleRemainTime(day){await checkScheduleRemainTimeGet(day);return checkScheduleRemainTimeVar}async function nowUserStatus(){var userStatusText="";await nowTimeToClassTime().then(nowTimeToClassTime=>{var date=new Date;var nowTime=date.getHours();var nowMinute=date.getMinutes();var dayOfWeek=date.getDay();var nowTimeCode=Number(String(nowTime)+String(nowMinute));if(nowTimeToClassTime.includes("êµì‹œ")){var isBreakTime=nowTimeToClassTime.split("êµì‹œ")[1]==" ì‰¬ëŠ”ì‹œê°„";if(isBreakTime){userStatusText="ì‰¬ëŠ”ì¤‘ğŸ˜´"}if(!isBreakTime){userStatusText="ììŠµì¤‘ğŸ–Šï¸"}var nowClassTimeNumber=nowTimeToClassTime.split("êµì‹œ")[0];for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==dayOfWeek){for(var k=0;k<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j]).length;k++){if(Number(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][k].split("-")[1])==nowClassTimeNumber){userStatusText="ìˆ˜ì—…ì¤‘ğŸ”¥";console.log("ìˆ˜ì—…ì¤‘ğŸ”¥")}}}}}}});return userStatusText}var nowClassInfoText="";async function nowClassInfoGet(){var userStatusData=await nowUserStatus();await nowTimeToClassTime().then(nowTimeToClassTime=>{var date=new Date;var dayOfWeek=date.getDay();if(userStatusData=="ìˆ˜ì—…ì¤‘ğŸ”¥"){var nowClassTimeNumber=nowTimeToClassTime.split("êµì‹œ")[0];for(var i=0;i<Object.keys(scheduleData["scheduleInfo"]).length;i++){for(var j=0;j<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"]).length;j++){if(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][0].split("-")[0]==dayOfWeek){for(var k=0;k<Object.keys(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j]).length;k++){if(Number(scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["timeData"][j][k].split("-")[1])==nowClassTimeNumber){nowClassInfoText=scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["teacher"]+" - "+scheduleData["scheduleInfo"][Object.keys(scheduleData["scheduleInfo"])[i]]["subject"]}}}}}}else{nowClassInfoText="ìˆ˜ì—…ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."}})}async function nowClassInfo(){await nowClassInfoGet();return nowClassInfoText}async function registerSchedule(code,time,teacher,subject,room,timeData){try{if(scheduleData["scheduleInfo"][code]!=undefined){return"ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤ì¼€ì¥´"}else{var timeData0;if(timeData.includes("/")){var timeData1=timeData.split("/")[0];var timeData2=timeData.split("/")[1];timeData0={0:timeData1,1:timeData2}}else{timeData0={0:timeData}}scheduleData["scheduleInfo"][code]={time:String(time),teacher:teacher,subject:subject,room:room,timeData:timeData0};console.log(scheduleData);await save()}}catch(err){scheduleData["scheduleInfo"][code]={};registerSchedule(code,time,teacher,subject,room,timeData)}}const TelegramBot=require("node-telegram-bot-api");const token="6164025343:AAG0SjQeYboUHXEl_4P9gwPQ04j7L0YSxv0";const bot=new TelegramBot(token,{polling:true});var userSetting={};bot.onText(/\/dev/,async msg=>{const chatId=msg.chat.id;bot.sendMessage(chatId,await nowClassInfo())});bot.onText(/\/menu/,msg=>{const chatId=msg.chat.id;const userId=msg.from.id;if(userSetting[userId]==undefined){userSetting[userId]={}}const options={reply_markup:{inline_keyboard:[[{text:"ë©”ì¸ ë©”ë‰´",callback_data:"main_menu"}],[{text:"ì„¤ì •",callback_data:"settings"}]]}};bot.sendMessage(chatId,"ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.",options)});bot.onText(/\/settings/,msg=>{const chatId=msg.chat.id;const userId=msg.from.id;if(userSetting[userId]==undefined){userSetting[userId]={}}const options={reply_markup:{inline_keyboard:[[{text:"ìˆ˜ì—… ê´€ë¦¬",callback_data:"manage_class"}]]}};bot.sendMessage(chatId,"ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.",options)});bot.on("callback_query",async query=>{try{console.log(query);const chatId=query.message.chat.id;const messageId=query.message.message_id;const data=query.data;const userId=query.from.id;var year=date.getFullYear();var month=date.getMonth()+1;var day=date.getDate();var dayOfWeek=date.getDay();var dayOfWeekKorean=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][dayOfWeek];if(data=="main_menu"){const options={reply_markup:{inline_keyboard:[[{text:"ë‚´ í•™ìŠµì •ë³´ í™•ì¸",callback_data:"my_study_info"}],[{text:"ì„¤ì •",callback_data:"settings"}]]}};bot.editMessageText("ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.",{chat_id:chatId,message_id:messageId,reply_markup:options.reply_markup})}if(data=="settings"){if(userSetting[userId]==undefined){userSetting[userId]={}}const options={reply_markup:{inline_keyboard:[[{text:"ìˆ˜ì—… ê´€ë¦¬",callback_data:"manage_class"}]]}};bot.sendMessage(chatId,"ì„¤ì •ì…ë‹ˆë‹¤.",options)}if(data=="my_study_info"){var myStudyInfoText=`[${year}ë…„ ${month}ì›” ${day}ì¼ ${dayOfWeekKorean}ìš”ì¼] ë‚´ í•™ìŠµì •ë³´\n\n`;if(await nowClassInfo()=="ìˆ˜ì—…ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."){myStudyInfoText+="ë‚´ ìƒíƒœ: "+await nowUserStatus()}else{myStudyInfoText+="ë‚´ ìƒíƒœ: "+await nowUserStatus()+"("+await nowClassInfo()+")"}myStudyInfoText+="\n"+await checkScheduleRemainTime(dayOfWeek);bot.editMessageText(myStudyInfoText,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ë©”ì¸ ë©”ë‰´",callback_data:"main_menu"}]]}})}if(data=="manage_class"){var message="ìˆ˜ì—… ê´€ë¦¬ ë©”ë‰´ì…ë‹ˆë‹¤.";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ìˆ˜ì—… ì¶”ê°€",callback_data:"add_class"}],[{text:"ìˆ˜ì—… ìˆ˜ì •",callback_data:"edit_class"}]]}})}if(data=="add_class"){const namePrompt1=await bot.sendMessage(query.message.chat.id,"ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nìˆ˜ì—…ì½”ë“œë¥¼ ë³´ë‚´ì£¼ì„¸ìš”.\n(1/6)",{reply_markup:{force_reply:true}});bot.onReplyToMessage(query.message.chat.id,namePrompt1.message_id,async classData1=>{userSetting[userId]["code"]=classData1.text;await bot.deleteMessage(query.message.chat.id,classData1.message_id);await bot.deleteMessage(query.message.chat.id,namePrompt1.message_id);const namePrompt2=await bot.sendMessage(query.message.chat.id,"ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nê°•ì‚¬ëª…ì„ ë³´ë‚´ì£¼ì„¸ìš”.\n(2/6)",{reply_markup:{force_reply:true}});bot.onReplyToMessage(query.message.chat.id,namePrompt2.message_id,async classData2=>{userSetting[userId]["teacher"]=classData2.text;var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nìˆ˜ì—…ì‹œìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n(3/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"3.5",callback_data:"add_class_time_3.5"}],[{text:"7",callback_data:"add_class_time_7"}]]}});bot.deleteMessage(query.message.chat.id,classData2.message_id);bot.deleteMessage(query.message.chat.id,namePrompt2.message_id)})})}if(data.includes("add_class_time_")){userSetting[userId]["time"]=data.split("_")[3];userSetting[userId]["time"]=3.5;var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nê³¼ëª©ëª…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n(4/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"êµ­ì–´",callback_data:"add_class_subject_êµ­ì–´"}],[{text:"ì˜ì–´",callback_data:"add_class_subject_ì˜ì–´"}],[{text:"ìˆ˜í•™",callback_data:"add_class_subject_ìˆ˜í•™"}]]}})}if(data.includes("add_class_subject_")){userSetting[userId]["subject"]=data.split("_")[3];var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nê°•ì˜ì‹¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n(5/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"201í˜¸",callback_data:"add_class_room_201"}],[{text:"202í˜¸",callback_data:"add_class_room_202"}],[{text:"203í˜¸",callback_data:"add_class_room_203"}],[{text:"204í˜¸",callback_data:"add_class_room_204"}],[{text:"205í˜¸",callback_data:"add_class_room_205"}],[{text:"206í˜¸",callback_data:"add_class_room_206"}],[{text:"207í˜¸",callback_data:"add_class_room_207"}],[{text:"208í˜¸",callback_data:"add_class_room_208"}],[{text:"VIPì‹¤",callback_data:"add_class_room_VIP"}]]}})}if(data.includes("add_class_room_")){userSetting[userId]["room"]=data.split("_")[3];var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nê°•ì˜ ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ì¼ìš”ì¼",callback_data:"add_class_day_0"}],[{text:"ì›”ìš”ì¼",callback_data:"add_class_day_1"}],[{text:"í™”ìš”ì¼",callback_data:"add_class_day_2"}],[{text:"ìˆ˜ìš”ì¼",callback_data:"add_class_day_3"}],[{text:"ëª©ìš”ì¼",callback_data:"add_class_day_4"}],[{text:"ê¸ˆìš”ì¼",callback_data:"add_class_day_5"}],[{text:"í† ìš”ì¼",callback_data:"add_class_day_6"}]]}})}if(data.includes("add_class_day_")){userSetting[userId]["day1"]=data.split("_")[3];var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nìˆ˜ì—… ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ì˜¤ì „",callback_data:"add_class_partTime_1"}],[{text:"ì ì‹¬",callback_data:"add_class_partTime_2"}],[{text:"ì €ë…",callback_data:"add_class_partTime_3"}]]}})}if(data.includes("add_class_partTime_")){userSetting[userId]["partTime"]=data.split("_")[3];if(userSetting[userId]["time"]==3.5){var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nìˆ˜ì—…ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê°•ì˜ ì½”ë“œ: "+userSetting[userId]["code"]+"\nê³¼ëª©: "+userSetting[userId]["subject"]+"\nê°•ì˜ì‹¤: "+userSetting[userId]["room"]+"\nê°•ì˜ ìš”ì¼: "+userSetting[userId]["day1"]+"\nê°•ì˜ ì‹œê°„ëŒ€: "+userSetting[userId]["partTime"]+"\n\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ë“±ë¡",callback_data:"add_class_final_okay"}],[{text:"ì·¨ì†Œ",callback_data:"add_class_final_cancel"}]]}})}else if(userSetting[userId]["time"]==7){var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\n7T ë‹¨ê³¼ëŠ” ì§€ì›í•˜ì§€ ì•Šê³  ìˆìœ¼ë‹ˆ, ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.\n\n(6/6)";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°",callback_data:"main_menu"}]]}})}}if(data.includes("add_class_final_")){console.log("!!!!!!!!");if(data.split("_")[3]=="okay"){var classDateInfo=[];if(userSetting[userId]["time"]==3.5){if(userSetting[userId]["partTime"]==1){classDateInfo.push(`${userSetting[userId]["day1"]}-2`);classDateInfo.push(`${userSetting[userId]["day1"]}-3`)}else if(userSetting[userId]["partTime"]==2){classDateInfo.push(`${userSetting[userId]["day1"]}-4`);classDateInfo.push(`${userSetting[userId]["day1"]}-5`);classDateInfo.push(`${userSetting[userId]["day1"]}-6`)}else if(userSetting[userId]["partTime"]==3){classDateInfo.push(`${userSetting[userId]["day1"]}-7`);classDateInfo.push(`${userSetting[userId]["day1"]}-8`)}registerSchedule(userSetting[userId]["code"],userSetting[userId]["time"],userSetting[userId]["teacher"],userSetting[userId]["subject"],userSetting[userId]["room"],classDateInfo);var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\në“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. âœ…";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°",callback_data:"main_menu"}]]}})}}if(data.split("_")[3]=="cancel"){var message="ìˆ˜ì—… ì¶”ê°€ ë©”ë‰´ì…ë‹ˆë‹¤.\n\nì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";bot.editMessageText(message,{chat_id:chatId,message_id:messageId,reply_markup:{inline_keyboard:[[{text:"ë‹¤ì‹œ ë“±ë¡í•˜ê¸°",callback_data:"add_class"}],[{text:"ë‚˜ê°€ê¸°",callback_data:"add_class_delete"}]]}})}}if(data.includes("add_class_delete")){await bot.deleteMessage(chatId,messageId)}}catch(err){console.log(err)}});